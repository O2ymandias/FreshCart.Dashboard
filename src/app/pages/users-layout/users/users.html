<section class="flex flex-col gap-6 px-6 py-12">
  <p-breadcrumb [model]="navigationItems" />

  <p-table #dt [value]="users()" rowHover="true" dataKey="id">
    <ng-template #caption>
      <div class="space-y-4">
        <div class="flex items-center gap-2">
          <h1 class="text-2xl font-bold">Manage Users</h1>
          <p-button
            rounded
            icon="pi pi-refresh"
            size="small"
            (onClick)="refresh()"
          />
        </div>

        <div
          class="flex flex-col items-center gap-4 md:flex-row md:items-center md:justify-between"
        >
          <p-inputgroup class="md:w-1/2 lg:w-2/5">
            <input
              type="search"
              pInputText
              pTooltip="By Id, Username, Email or Phone Number"
              tooltipPosition="top"
              tooltipEvent="focus"
              placeholder="Search users"
              [(ngModel)]="searchQuery"
              (keyup.enter)="search()"
            />
            <p-inputgroup-addon>
              <p-button
                icon="pi pi-search"
                severity="secondary"
                variant="text"
                (onClick)="search()"
              />
            </p-inputgroup-addon>
          </p-inputgroup>

          <p-select
            [options]="roles()"
            [(ngModel)]="selectedRole"
            optionLabel="name"
            placeholder="Filter by role"
            showClear="true"
            class="w-full md:w-1/4 lg:w-1/5"
            (onChange)="filter()"
          />
        </div>
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th>UserName</th>
        <th>Email</th>
        <th>Phone Number</th>
        <th>Roles</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template #body let-user>
      <tr>
        <td>{{ user.userName }}</td>
        <td>
          <app-email-link [email]="user.email" />
        </td>
        <td>
          @if (user.phoneNumber) {
            <app-phone-link [phoneNumber]="user.phoneNumber" />
          } @else {
            <span class="text-gray-400">N/A</span>
          }
        </td>
        <td>{{ user.roles.join(", ") }}</td>
        <td>
          <div class="flex items-center gap-2">
            <a
              pButton
              icon="pi pi-search"
              rounded
              outlined
              [routerLink]="['/', 'users', 'details', user.id]"
            >
            </a>
            <p-button
              icon="pi pi-key"
              severity="info"
              rounded
              outlined
              (click)="assignToRole(user)"
            />
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #footer>
      <tr>
        <td colspan="8">
          <p-paginator
            [rows]="pageSize()"
            [totalRecords]="totalRecords()"
            [rowsPerPageOptions]="rowsPerPageOptions"
            [first]="first()"
            [showCurrentPageReport]="true"
            [currentPageReportTemplate]="
              'Showing {first} to {last} of {totalRecords} entries'
            "
            (onPageChange)="onPageChange($event)"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>
</section>

@let user = userToAssignRoles();
@let availableRoles = roles();
@if (user && availableRoles) {
  <p-dialog
    header="Assign User to a Role"
    [modal]="true"
    [(visible)]="showAssignToRoleDialog"
    styleClass="w-3/4 md:w-1/2"
    [closeButtonProps]="{
      severity: 'secondary',
      rounded: true,
      outlined: true,
    }"
  >
    <app-assign-to-role
      [roles]="availableRoles"
      [user]="user"
      (onUpdate)="onAssignToRole()"
    />
  </p-dialog>
}
